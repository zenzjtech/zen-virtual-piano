# 2025-11-16: Fix Sound Settings Popup Closing on MIDI Select Click

## Summary
Fixed an issue where the sound settings popup would unexpectedly close when clicking on the MIDI device select dropdown. Applied the same technique used in the sheet search dialog to prevent popup closure when select menus are open.

## Changes Made

### sound-settings-popup.tsx
- Added `isMidiSelectOpen` state to track when the MIDI select dropdown is open
- Created `handleClickAway` function that prevents popup closure when MIDI select is open
- Added `onOpen` and `onClose` props to the MIDI Select component to update the state
- Updated ClickAwayListener to use the custom `handleClickAway` function

## Technical Details
The fix follows the same pattern as the sheet search dialog:
1. Track select dropdown state with boolean flag
2. Check this flag in click away handler before closing
3. Update state when select opens/closes via onOpen/onClose props

This prevents accidental popup closure while users are interacting with the MIDI device selection dropdown.

## Impact
- Small: Only affects sound settings popup behavior
- Low risk: No breaking changes, only improves UX
- High benefit: Fixes frustrating user experience issue

## Next Steps
1. Test MIDI device selection functionality
2. Verify popup behavior with other select components
3. Consider applying similar fix to other popups with select components

---

## Additional Changes: Refactor Click Away Handling with Custom Hook

### Summary
Refactored the duplicated click-away handling logic into a reusable custom hook `usePopupSelectHandler` to improve code reusability and maintainability. This eliminates code duplication between the sound settings popup and sheet search dialog components.

### New Changes Made

#### New Hook: use-popup-select-handler.ts
- Created a new custom hook that manages popup select state and click-away behavior
- Provides `handleClickAway`, `handleSelectOpen`, `handleSelectClose`, and `isAnySelectOpen` functions
- Handles MUI component detection to prevent closing when interacting with dropdowns

#### Sound Settings Popup (sound-settings-popup.tsx)
- Replaced manual `isMidiSelectOpen` state and `handleClickAway` function with the custom hook
- Updated MIDI Select component to use hook's open/close handlers
- Removed 18 lines of duplicated logic

#### Sheet Search Dialog (sheet-search-dialog.tsx)
- Replaced manual `isSortSelectOpen` state and `handleClickAway` function with the custom hook
- Updated SheetSearchFilters component call to use hook's handlers
- Removed 19 lines of duplicated logic

#### Sheet Search Filters (sheet-search-filters.tsx)
- Updated interface to accept separate `onSortSelectOpen` and `onSortSelectClose` handlers
- Updated Select component to use the separate handlers
- Improved type safety by removing boolean parameter

### Technical Details
The hook centralizes the complex click-away logic that:
1. Tracks when any select dropdown is open
2. Prevents popup closure when selects are active
3. Detects clicks on MUI components (Popover, Modal, Menu, Paper, Backdrop)
4. Maintains consistent behavior across all popup components

### Updated Impact
- **Small impact**: Only affects popup behavior, no user-facing changes
- **Low risk**: No breaking changes, only internal refactoring
- **High maintainability**: Eliminates code duplication and provides consistent behavior
- **Future-proof**: Easy to extend for additional popup components with selects

### Updated Next Steps
1. **Test popup behavior**: Verify that both sound settings and sheet search popups work correctly
2. **Apply to other popups**: Consider using this hook in other popup components that have select elements
3. **Extend functionality**: Add support for multiple concurrent selects if needed
4. **Performance check**: Ensure the hook doesn't cause unnecessary re-renders

---

## Additional Changes: Update Sheet Search Toggle Functionality

### PianoUnit (piano-unit.tsx)
- Added `handleSoundToggle` function for sound settings popup toggle behavior
- Added `handleSheetSearchToggle` function for sheet search dialog toggle behavior
- Updated StatusBoard to use toggle handler instead of direct open handler
- Updated SettingsBar to use toggle handler for sound button

### Sheet Search Dialog Toggle Behavior
- **Sheet Search Button**: Now toggles the sheet search dialog open/close when clicked
- **Toggle Logic**: Checks Redux state `isSheetSearchOpen` to determine whether to open or close the dialog
- **Event Handling**: Passes the original mouse event to `onSheetSearchOpen` when opening, dispatches `closeSearchDialog()` when closing

### Updated Impact
- **Small impact**: Only affects button behavior, no user-facing visual changes
- **Low risk**: No breaking changes, only improves UX with toggle functionality
- **High user experience improvement**: Both Sound and Sheet buttons now provide expected toggle behavior
- **Consistent behavior**: Both major popup buttons now work the same way (toggle vs always-open)

#### New Hook: use-popup-toggle.ts
- Created `usePopupToggle` hook for reusable toggle behavior
- Takes `isOpen`, `onOpen`, `onClose`, and `needsEvent` parameters
- Returns `handleToggle` and `handleClose` functions
- Handles both event-based and non-event-based popup opening

#### PianoUnit (piano-unit.tsx)
- Replaced manual toggle handler implementations with `usePopupToggle` hook
- **Sound Settings**: Uses `usePopupToggle(soundSettingsPopup.isOpen, soundSettingsPopup.handleOpen, soundSettingsPopup.handleClose, true)`
- **Sheet Search**: Uses `usePopupToggle(isSheetSearchOpen, onSheetSearchOpen, () => dispatch(closeSearchDialog()), true)`
- Kept `handleSoundSettingsClose` for Redux state synchronization (escape key handler)
- Updated StatusBoard and SettingsBar to use hook-provided toggle handlers

### Updated Impact
- **Small impact**: Only affects button behavior, no user-facing visual changes
- **Low risk**: No breaking changes, only internal refactoring
- **High maintainability**: Toggle logic is now reusable and consistent
- **Future-proof**: Easy to add toggle behavior to other popups using the same hook

---

## Additional Changes: Add Mixpanel Analytics Tracking for Instrument Settings

### Summary
Added Mixpanel tracking for instrument-related user interactions to better understand user behavior and instrument preferences.

### Changes Made

#### utils/constants.ts
- Added `INSTRUMENT_SELECTOR_OPENED` and `INSTRUMENT_CHANGED` to `ANALYTICS_ACTION` constants

#### instrument-setting.tsx
- Added Redux selector for user ID
- Added `trackEvent` import and analytics constants
- Created `handleClick` function that tracks when instrument selector is opened
- Updated button `onClick` to use the new handler

#### piano-unit.tsx
- Added analytics tracking in `handleSoundSetChange` when a new instrument is selected
- Tracks previous and new instrument IDs

### Technical Details
- Uses existing `trackEvent` function from analytics utils
- Follows the same pattern as other analytics events in the codebase
- Tracks meaningful properties: current/previous instrument for context

### Impact
- **Small impact**: Only adds tracking, no user-facing changes
- **Low risk**: No breaking changes, only additional functionality
- **High value**: Provides insights into instrument usage patterns

---

## Additional Changes: Add Mixpanel Analytics Tracking for Sound Settings Button

### Summary
Added Mixpanel tracking for the sound settings button click in the settings bar to track when users open the sound settings popup.

### Changes Made

#### utils/constants.ts
- Added `SOUND_SETTINGS_OPENED` to `ANALYTICS_ACTION` constants

#### settings-bar.tsx
- Added Redux selector for user ID
- Added `trackEvent` import and analytics constants
- Created `handleSoundClick` function that tracks when sound settings are opened
- Updated Sound button `onClick` to use the new handler

### Technical Details
- Uses existing `trackEvent` function from analytics utils
- Follows the same pattern as other analytics events in the codebase
- Tracks when the sound settings popup is opened via button click

### Impact
- **Small impact**: Only adds tracking, no user-facing changes
- **Low risk**: No breaking changes, only additional functionality
- **High value**: Provides insights into sound settings usage

---

## Additional Changes: Add Mixpanel Analytics Tracking for Styles and Key Assist Buttons

### Summary
Added Mixpanel tracking for the Appearances (Styles) and Key Assist button clicks in the settings bar to track when users open these settings popups.

### Changes Made

#### utils/constants.ts
- Added `STYLES_SETTINGS_OPENED` and `KEY_ASSIST_OPENED` to `ANALYTICS_ACTION` constants

#### settings-bar.tsx
- Added `handleStylesClick` function that tracks when styles settings are opened
- Added `handleKeyAssistClick` function that tracks when key assist is opened
- Updated Appearances button `onClick` to use `handleStylesClick`
- Updated Key Assist button `onClick` to use `handleKeyAssistClick`

### Technical Details
- Uses existing `trackEvent` function from analytics utils
- Follows the same pattern as other analytics events in the codebase
- Tracks when the styles and key assist popups are opened via button clicks

### Impact
- **Small impact**: Only adds tracking, no user-facing changes
- **Low risk**: No breaking changes, only additional functionality
- **High value**: Provides insights into settings usage patterns

---

## Additional Changes: Add Comprehensive Settings Analytics Tracking

### Summary
Added comprehensive analytics tracking for all user settings changes across the application, including sound settings, theme changes, and music sheet display preferences.

### Changes Made

#### utils/constants.ts
- Added extensive analytics action constants for all settings changes:
  - `SUSTAIN_CHANGED`, `TRANSPOSE_CHANGED`, `VOLUME_CHANGED`
  - `METRONOME_TOGGLED`, `METRONOME_TEMPO_CHANGED`, `METRONOME_VOLUME_CHANGED`
  - `PIANO_THEME_CHANGED`, `BACKGROUND_THEME_CHANGED`, `MUSIC_SHEET_THEME_CHANGED`, `PATTERN_THEME_CHANGED`
  - `KEYBOARD_DISPLAY_TOGGLED`, `NOTE_NAMES_TOGGLED`

#### New Hook: use-settings-analytics.ts
- Created `useSettingsAnalytics` hook to track Redux state changes:
  - Monitors sustain, keyboard display, note names, and all theme changes
  - Uses debouncing for sustain changes to avoid excessive tracking
  - Tracks immediate changes for toggles and theme selections

- Created `useSoundSettingsAnalytics` hook to track local sound settings:
  - Monitors transpose, volume, metronome settings
  - Uses debouncing for volume and metronome continuous settings
  - Tracks immediate changes for transpose and metronome toggle

#### entrypoints/piano/App.tsx
- Integrated both analytics hooks to track all settings changes
- Added hooks after existing initialization hooks
- Passes soundSettings values to the sound analytics hook

### Technical Details
- **Debouncing Strategy**: Continuous settings (sustain, volume, metronome tempo/volume) use 500ms debouncing to prevent excessive analytics events
- **Immediate Tracking**: Toggle and discrete settings (themes, transpose, metronome on/off) are tracked immediately
- **Separation of Concerns**: Redux state changes vs local state changes are handled by separate hooks
- **Cleanup**: Proper timer cleanup on component unmount

### Impact
- **Small impact**: Only adds tracking, no user-facing changes
- **Low risk**: No breaking changes, only additional functionality
- **High value**: Provides comprehensive insights into user preferences and settings usage patterns

### Next Steps
1. Monitor analytics data for user settings behavior patterns
2. Consider adding more granular tracking for specific UI interactions
3. Analyze settings usage to inform future feature development
4. Verify tracking works correctly across different user scenarios

## Person
Cascade
