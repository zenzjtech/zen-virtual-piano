# 2025-11-16: Fix Sound Settings Popup Closing on MIDI Select Click

## Summary
Fixed an issue where the sound settings popup would unexpectedly close when clicking on the MIDI device select dropdown. Applied the same technique used in the sheet search dialog to prevent popup closure when select menus are open.

## Changes Made

### sound-settings-popup.tsx
- Added `isMidiSelectOpen` state to track when the MIDI select dropdown is open
- Created `handleClickAway` function that prevents popup closure when MIDI select is open
- Added `onOpen` and `onClose` props to the MIDI Select component to update the state
- Updated ClickAwayListener to use the custom `handleClickAway` function

## Technical Details
The fix follows the same pattern as the sheet search dialog:
1. Track select dropdown state with boolean flag
2. Check this flag in click away handler before closing
3. Update state when select opens/closes via onOpen/onClose props

This prevents accidental popup closure while users are interacting with the MIDI device selection dropdown.

## Impact
- Small: Only affects sound settings popup behavior
- Low risk: No breaking changes, only improves UX
- High benefit: Fixes frustrating user experience issue

## Next Steps
1. Test MIDI device selection functionality
2. Verify popup behavior with other select components
3. Consider applying similar fix to other popups with select components

---

## Additional Changes: Refactor Click Away Handling with Custom Hook

### Summary
Refactored the duplicated click-away handling logic into a reusable custom hook `usePopupSelectHandler` to improve code reusability and maintainability. This eliminates code duplication between the sound settings popup and sheet search dialog components.

### New Changes Made

#### New Hook: use-popup-select-handler.ts
- Created a new custom hook that manages popup select state and click-away behavior
- Provides `handleClickAway`, `handleSelectOpen`, `handleSelectClose`, and `isAnySelectOpen` functions
- Handles MUI component detection to prevent closing when interacting with dropdowns

#### Sound Settings Popup (sound-settings-popup.tsx)
- Replaced manual `isMidiSelectOpen` state and `handleClickAway` function with the custom hook
- Updated MIDI Select component to use hook's open/close handlers
- Removed 18 lines of duplicated logic

#### Sheet Search Dialog (sheet-search-dialog.tsx)
- Replaced manual `isSortSelectOpen` state and `handleClickAway` function with the custom hook
- Updated SheetSearchFilters component call to use hook's handlers
- Removed 19 lines of duplicated logic

#### Sheet Search Filters (sheet-search-filters.tsx)
- Updated interface to accept separate `onSortSelectOpen` and `onSortSelectClose` handlers
- Updated Select component to use the separate handlers
- Improved type safety by removing boolean parameter

### Technical Details
The hook centralizes the complex click-away logic that:
1. Tracks when any select dropdown is open
2. Prevents popup closure when selects are active
3. Detects clicks on MUI components (Popover, Modal, Menu, Paper, Backdrop)
4. Maintains consistent behavior across all popup components

### Updated Impact
- **Small impact**: Only affects popup behavior, no user-facing changes
- **Low risk**: No breaking changes, only internal refactoring
- **High maintainability**: Eliminates code duplication and provides consistent behavior
- **Future-proof**: Easy to extend for additional popup components with selects

### Updated Next Steps
1. **Test popup behavior**: Verify that both sound settings and sheet search popups work correctly
2. **Apply to other popups**: Consider using this hook in other popup components that have select elements
3. **Extend functionality**: Add support for multiple concurrent selects if needed
4. **Performance check**: Ensure the hook doesn't cause unnecessary re-renders
