# 2025-11-10 - Sheet Detection Banner Implementation & Refactoring

## Summary
Implemented a banner that displays sheet name and author information when a sheet is detected from virtualpiano.net, positioned between the header and download button in the download UI. Also refactored to eliminate code duplication by creating a shared function for title/artist extraction.

## Changes Made

### 1. Type Definitions (`src/entrypoints/vp-download-ui/types.ts`)
- Added `SheetDetectedMessage` interface for cross-frame communication
- Updated `DownloadMessage` type union to include sheet detection messages
- Added `SHEET_DETECTED` message type to `MESSAGE_TYPES` constants

### 2. VirtualPiano Scraper (`src/utils/virtualpiano-scraper.ts`)
- **NEW**: Added `extractSheetTitleAndArtist()` function to extract only title and artist from pages
- **REFACTORED**: `scrapeVirtualPianoSheet()` now uses the shared `extractSheetTitleAndArtist()` function instead of duplicating logic
- Eliminated code duplication between sheet detection and full scraping

### 3. Content Script (`src/entrypoints/virtualpiano.content.ts`)
- **REFACTORED**: `extractSheetInfo()` now uses the shared `extractSheetTitleAndArtist()` function from virtualpiano-scraper
- Changed to async function with dynamic import for better modularity
- Simplified code by removing duplicate title/artist extraction logic

### 4. Download State Hook (`src/components/global/hooks/use-download-state.ts`)
- Added `sheetInfo` state to track detected sheet information
- Added handler for `SHEET_DETECTED` messages in the message listener
- Updated return interface to include `sheetInfo`

### 5. Sheet Banner Component (`src/components/global/components/sheet-banner.tsx`)
- Created new `SheetBanner` component with glassmorphic styling
- Displays sheet title prominently and artist in a chip component
- Responsive design with text truncation for long titles
- Matches the visual theme of the download UI

### 6. Main App Component (`src/entrypoints/vp-download-ui/App.tsx`)
- Added conditional rendering of `SheetBanner` between header and download button
- Only displays banner when sheet information is available
- Integrated with existing layout and spacing

## Technical Details

### Message Flow
1. Content script detects virtualpiano.net sheet page
2. Extracts title and artist information on page load using shared function
3. Sends `SHEET_DETECTED` message to iframe
4. Download UI receives message and updates state
5. Banner renders with sheet information

### Code Reuse
- Created `extractSheetTitleAndArtist()` as a shared utility function
- Both content script detection and full scraping now use the same extraction logic
- Reduced code duplication from ~40 lines to ~5 lines in content script

### Data Extraction Strategy
- Primary: Direct DOM selectors (`.sheet__head-wrapper h1`, `.sheet__author a`)
- Secondary: Page title parsing with regex
- Tertiary: URL path conversion to title case

### UI/UX Considerations
- Banner only appears when sheet is detected
- Maintains existing layout proportions
- Uses consistent glassmorphic styling
- Responsive text handling for various title lengths

## Impact
- **Small** impact: New feature addition with code refactoring
- **Low** risk: Isolated UI enhancement with proper error handling and code reuse
- Improves code maintainability by eliminating duplication
- Enhances user experience by providing immediate feedback about detected sheet

## Testing Notes
- Banner should appear on valid virtualpiano.net sheet pages
- Should gracefully handle pages without detectable sheet info
- Maintains existing download functionality
- Title/artist extraction should work consistently across detection and download flows
- Responsive across different screen sizes

## Code Splitting Refactor - Toast Notification Component

### Summary
Extracted the toast notification functionality from the main App component into a separate, reusable ToastNotification component to improve code organization and maintainability.

### Changes Made

#### 1. Toast Notification Component (`src/components/global/components/toast-notification.tsx`)
- **NEW**: Created dedicated `ToastNotification` component
- Encapsulates Snackbar and Alert logic for download status messages
- Accepts `showToast`, `setShowToast`, and `downloadState` as props
- Maintains all existing functionality (auto-hide, positioning, severity mapping, icons)

#### 2. Component Exports (`src/components/global/components/index.ts`)
- Added export for `ToastNotification` component
- Enables clean imports from the components barrel file

#### 3. Main App Component (`src/entrypoints/vp-download-ui/App.tsx`)
- **REFACTORED**: Replaced inline Snackbar JSX with `<ToastNotification>` component
- Removed unused imports (`Alert`, `Snackbar`, `MusicNote`, `TIMING`)
- Added `ToastNotification` to component imports
- Preserved all existing behavior and props

### Technical Details

#### Component Interface
```typescript
interface ToastNotificationProps {
  showToast: boolean;
  setShowToast: (show: boolean) => void;
  downloadState: DownloadState;
}
```

#### Benefits
- **Separation of Concerns**: UI notification logic isolated from main download logic
- **Reusability**: ToastNotification can now be used in other parts of the application
- **Maintainability**: Easier to modify toast behavior without touching the main App component
- **Code Organization**: Reduced App.tsx file size and complexity

### Impact
- **Small** impact: Pure refactoring with no functional changes
- **Low** risk: No behavioral changes, only code organization
- Improves code maintainability and follows React best practices for component composition

### Testing Notes
- Toast notifications should work identically to before
- All status types (success, warning, error) display correctly
- Auto-hide timing and positioning unchanged
- Close functionality preserved

## Future Enhancements
- Could extend to show additional metadata (difficulty, tempo)
- Animation transitions for banner appearance
- Sheet preview/thumbnail integration

---
*Implemented by: AI Assistant*
*Date: 2025-11-10*
